name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2
      
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      
    - name: Restore NuGet packages
      working-directory: .
      run: nuget restore "QR Code Reader.sln"
      
    - name: Build solution
      working-directory: .
      run: msbuild "QR Code Reader.sln" /p:Configuration=Release /p:Platform="Any CPU" /p:DebugSymbols=false /p:DebugType=None /verbosity:minimal
      
    - name: List build output
      shell: powershell
      run: |
        Write-Host "Build directory contents:"
        Get-ChildItem -Recurse "QR Code Reader\bin\Release" -ErrorAction SilentlyContinue | Select-Object FullName
        
    - name: Create Release Package
      shell: powershell
      run: |
        $releaseDir = "BarcodeReader-v2.0.0"
        $buildDir = "QR Code Reader\bin\Release"
        
        Write-Host "Creating release directory..."
        New-Item -ItemType Directory -Force -Path $releaseDir
        
        Write-Host "Copying files..."
        Copy-Item "$buildDir\Barcode Reader.exe" $releaseDir\ -ErrorAction Stop
        Copy-Item "$buildDir\*.dll" $releaseDir\ -ErrorAction SilentlyContinue
        Copy-Item "$buildDir\Barcode Reader.exe.config" $releaseDir\ -ErrorAction SilentlyContinue
        
        if (Test-Path "$buildDir\Resources") {
          Copy-Item -Recurse "$buildDir\Resources" $releaseDir\ -ErrorAction SilentlyContinue
        }
        
        @"
        Barcode Reader v2.0.0
        =====================
        
        MAJOR STABILITY IMPROVEMENTS!
        - Fixed crashes (no more Thread.Abort)
        - Better memory management
        - Thread-safe operations  
        - Improved error handling
        
        REQUIREMENTS:
        - Windows 7 or later
        - .NET Framework 4.5.2+
        - Webcam
        
        INSTALLATION:
        1. Extract this ZIP
        2. Run 'Barcode Reader.exe'
        3. Done!
        
        GitHub: https://github.com/pieewiee/Barcode-Reader
        "@ | Out-File -FilePath "$releaseDir\README.txt" -Encoding UTF8
        
        Write-Host "Creating ZIP..."
        Compress-Archive -Path $releaseDir -DestinationPath "BarcodeReader-v2.0.0.zip" -Force
        
        Write-Host "Release package created!"
        Get-Item BarcodeReader-v2.0.0.zip
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BarcodeReader-v2.0.0
        path: BarcodeReader-v2.0.0.zip
        if-no-files-found: error
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: BarcodeReader-v2.0.0.zip
        name: Barcode Reader v2.0.0
        body: |
          ## üéâ Major Stability Release!
          
          ### What's Fixed
          - ‚ùå **Removed Thread.Abort()** ‚Üí Proper CancellationToken pattern
          - ‚úÖ **Memory leaks fixed** ‚Üí Proper Bitmap disposal
          - ‚úÖ **Thread-safety** ‚Üí Lock statements prevent race conditions
          - ‚úÖ **Exception handling** ‚Üí Comprehensive try-catch blocks
          - ‚úÖ **Clean shutdown** ‚Üí Proper resource cleanup
          
          ### Installation
          1. Download `BarcodeReader-v2.0.0.zip`
          2. Extract anywhere
          3. Run `Barcode Reader.exe`
          
          ### Requirements
          - Windows 7+
          - .NET Framework 4.5.2+
          - Webcam
          
          **No more random crashes!** üöÄ
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
